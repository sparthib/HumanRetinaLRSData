---
title: "Retinal Organoids counts data: Gene and Isoform Level Exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(HumanRetinaLRSData)
library(SummarizedExperiment)
library(dplyr)
library(ggplot2)
library(ggrepel)
```

## Overview

This vignette demonstrates how to load and visualize retinal organoids counts data at both the gene and isoform levels and visualize using PCA (Principal Component Analysis). We'll explore expression patterns across different developmental stages.

## Load Data

First, we load the gene-level and isoform-level data:

```{r load-data}
se_gene <- ROGeneLevelData()
se_isoform <- ROIsoformLevelData()
```

## Define PCA Plotting Function

To avoid code duplication, we create a reusable function for generating PCA plots:

```{r pca-function}
#' Plot PCA from SummarizedExperiment Object
#'
#' @param se SummarizedExperiment object containing expression data
#' @param assay_name Name of the assay to use (default: "cpm")
#' @param color_by Column name in colData to color points by (default: "stage")
#' @param title_prefix Text to include in plot title
#' @param color_mapping Named vector of colors for each group
#' @return A ggplot object
plot_pca <- function(se, 
                     assay_name = "cpm",
                     color_by = "stage",
                     title_prefix = "Expression",
                     color_mapping = NULL) {
  
  # Extract expression data
  expr_data <- assay(se, assay_name)
  
  # Perform PCA on log-transformed CPM values
  pca_result <- prcomp(t(log2(expr_data + 1)), scale = TRUE)
  
  # Create data frame with PC coordinates
  pca_df <- data.frame(
    PC1 = pca_result$x[, 1],
    PC2 = pca_result$x[, 2],
    sample = colnames(expr_data),
    group = colData(se)[[color_by]]
  )
  
  # Calculate variance explained
  var_explained <- pca_result$sdev^2 / sum(pca_result$sdev^2) * 100
  
  # Set default color mapping if not provided
  if (is.null(color_mapping)) {
    color_mapping <- c("stage 1" = "orange", 
                       "stage 2" = "seagreen",
                       "stage 3" = "purple")
  }
  
  # Calculate axis extensions for label space
  x_range <- range(pca_df$PC1)
  y_range <- range(pca_df$PC2)
  x_extend <- diff(x_range) * 0.1
  y_extend <- diff(y_range) * 0.1
  
  # Create plot
  p <- ggplot(pca_df, aes(x = PC1, y = PC2, color = group)) +
    geom_point(size = 3) +
    geom_label_repel(
      aes(label = sample),
      size = 2.5,
      fill = "white",
      alpha = 0.7,
      max.overlaps = Inf,
      box.padding = 0.5,
      point.padding = 0.3,
      segment.color = "grey50",
      show.legend = FALSE
    ) +
    scale_color_manual(values = color_mapping, name = "Stage") +
    xlim(x_range[1] - x_extend, x_range[2] + x_extend) +
    ylim(y_range[1] - y_extend, y_range[2] + y_extend) +
    labs(
      title = paste("PCA of", title_prefix),
      x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
      y = paste0("PC2 (", round(var_explained[2], 1), "%)")
    ) +
    theme_bw(base_size = 12) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold"),
      legend.position = "right"
    ) +
    guides(color = guide_legend(override.aes = list(size = 4)))
  
  return(p)
}
```

## Visualize Gene-Level Expression

Now we can easily create a PCA plot for gene-level data:

```{r plot-gene-pca, fig.width=8, fig.height=6}
# Define color scheme
stage_colors <- c("stage 1" = "orange", 
                  "stage 2" = "seagreen",
                  "stage 3" = "purple")

# Plot gene-level PCA
plot_gene <- plot_pca(
  se = se_gene,
  assay_name = "cpm",
  color_by = "stage",
  title_prefix = "Gene-Level Expression",
  color_mapping = stage_colors
)

print(plot_gene)
```

## Visualize Isoform-Level Expression

We can use the same function to plot isoform-level data:

```{r plot-isoform-pca, fig.width=8, fig.height=6}
# Plot isoform-level PCA
plot_isoform <- plot_pca(
  se = se_isoform,
  assay_name = "cpm",
  color_by = "stage",
  title_prefix = "Isoform-Level Expression",
  color_mapping = stage_colors
)

print(plot_isoform)
```

## Interpretation

The PCA plots reveal:

-   **Separation by stage**: Samples cluster by developmental stage, indicating distinct expression profiles
-   **Variance explained**: PC1 and PC2 capture the major sources of variation in the dataset
-   **Gene vs. Isoform**: While samples cluster similarly by developmental stage at both levels, the proportion of variance explained by each PC differs. This reflects that isoform-level analysis may capture additional complexity from alternative splicing and transcript variation beyond what is seen at the gene level.

## Session Information

```{r session-info}
sessionInfo()
```
